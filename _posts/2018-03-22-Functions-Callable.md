---
layout: post
title:  "Firebase Cloud Functions — chame uma função na sua app Android"
date:   2018-02-19 05:00:00 +0200
categories: firebase
---
O artigo original pode ser encontrado no [Medium](https://medium.com/@rosariopfernandes/fcf-callable-48d503a6cd24).
<section name="6489" class="section section--body section--first"><p name="c5ed" id="c5ed" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Este artigo é parte da série Firebase Cloud Functions:</strong></p><ol class="postList"><li name="aebc" id="aebc" class="graf graf--li graf-after--p"><a href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" data-href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" class="markup--anchor markup--li-anchor" target="_blank">O que é Firebase Cloud Functions?</a></li><li name="192b" id="192b" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Como começar?</a></li><li name="8f70" id="8f70" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" data-href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions + Cloud Messaging</a></li><li name="852d" id="852d" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Limpeza e Manutenção da Realtime Database</a></li><li name="d106" id="d106" class="graf graf--li graf-after--li">Firebase Cloud Functions — Chame uma função na sua app</li><li name="f6eb" id="f6eb" class="graf graf--li graf-after--li graf--trailing"><a href="/firebase/2019/01/31/Functions-Pesquisa-Texto.html" data-href="https://medium.com/android-dev-moz/fcf-search-7fd744b60dee" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Pesquisa de Texto na Base de Dados</a></li></ol></section><section name="c079" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="405c" id="405c" class="graf graf--p graf--leading">Uma das funcionalidades do Android Studio que comecei a apreciar recentemente é a Notificação. Isto porque na noite passada, eu abri o Android Studio e apareceu-me a notificação: “Google Play Services has a new update”. Achei curioso, porque sei que o Firebase está incluso neste pacote.<br>Fui então à página de <a href="https://firebase.google.com/support/release-notes/android" data-href="https://firebase.google.com/support/release-notes/android" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">notas de lançamento do firebase</a> e descobri uma nova funcionalidade que achei interessante: <a href="https://firebase.google.com/docs/functions/callable?hl=pt-pt" data-href="https://firebase.google.com/docs/functions/callable?hl=pt-pt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Callable Cloud Functions</strong></a>✨.</p><p name="df24" id="df24" class="graf graf--p graf-after--p">Decidi então experimentar esta nova funcionalidade, escrever este artigo a descrever a minha experiência e adicioná-lo à minha série de artigos sobre <a href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" data-href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" class="markup--anchor markup--p-anchor" target="_blank">Cloud Functions</a>.</p><h3 name="cc4e" id="cc4e" class="graf graf--h3 graf-after--p">Callable Cloud Functions?</h3><p name="587c" id="587c" class="graf graf--p graf-after--h3">Bom, acho melhor começar por explicar o que é isto. Callable Cloud Functions é o SDK do Cloud Functions para dispositivos clientes (Android, iOS ou Web). Esta funcionalidade permite chamar uma função diretamente do dispositivo cliente. A principal vantagem é que ao chamar a função, os tokens do Firebase Auth e do Cloud Messaging são incluídos nessa chamada e passados à função.</p><p name="d5ad" id="d5ad" class="graf graf--p graf-after--p">Esta funcionalidade pode resolver um dos problemas que vimos num dos artigos desta série: <a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--p-anchor" target="_blank">“limpeza” da base de dados</a>, onde criamos uma função para remover palavrões das mensagens que o utilizador envia para a nossa base de dados. Nesse <a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--p-anchor" target="_blank">artigo sobre limpeza e manutenção da Realtime Database</a>, não foi mencionado, mas a mensagem pode levar algum tempo para ser alterada. E alguns utilizadores irão ver esta mensagem não alterada, o que não devia acontecer pois, preferencialmente, todos utilizadores devem ter a mesma experiência.<br>Vamos então procurar resolver esse problema, garantindo que a mensagem publicada na base de dados já esteja alterada e sem palavrões.</p><h3 name="09dd" id="09dd" class="graf graf--h3 graf-after--p">Como começar?</h3><p name="fad5" id="fad5" class="graf graf--p graf-after--h3">Bom, para começar, o primeiro passo é ter a nossa função. Eu já tinha criado a função de remover palavrões no <a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--p-anchor" target="_blank">artigo que mencionei</a> anteriormente, por isso, vou re-utilizar essa função neste artigo.<br>Não vou explicar como inicializar o Cloud Functions, assumindo que você já sabe fazer isso. Mas caso não saiba, leia <a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--p-anchor" target="_blank">este artigo meu</a> que explica isso.</p><h4 name="6173" id="6173" class="graf graf--h4 graf-after--p">Adaptando a Cloud Function existente</h4><p name="e420" id="e420" class="graf graf--p graf-after--h4">A função que eu tinha era chamada através de um Database Trigger, ou seja, era chamada quando ocorria uma alteração na base de dados (quando um utilizador adicionava uma nova mensagem neste caso). Eis o código da função anterior:</p><figure name="fbf6" id="fbf6" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/90af14f2383e6d53701aded2058fd174#file-index-js.js"></script></figure><p name="2ba6" id="2ba6" class="graf graf--p graf-after--figure">Vamos então tornar ela em uma Callable Cloud Function. Para começar, substituímos o Database Trigger por <a href="https://firebase.google.com/docs/reference/functions/functions.https#.onCall" data-href="https://firebase.google.com/docs/reference/functions/functions.https#.onCall" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">functions.https.onCall</a>. Este método recebe 2 parâmetros: <code class="markup--code markup--p-code">data</code> e <code class="markup--code markup--p-code">context</code> (opcional).</p><pre name="4f64" id="4f64" class="graf graf--pre graf-after--p">exports.limpezaManutencao = functions.https.onCall((data, context) =&gt; {</pre><p name="56ac" id="56ac" class="graf graf--p graf-after--pre">Por padrão, o <code class="markup--code markup--p-code">context</code> irá conter os dados de autenticação do utilizador que fez o login na app Android(acessíveis através de <code class="markup--code markup--p-code">context.auth</code>) e o <code class="markup--code markup--p-code">data</code> é utilizado para enviar dados da app android para a Cloud Function.</p><p name="cbcc" id="cbcc" class="graf graf--p graf-after--p">Note que também precisaremos do <a href="https://firebase.google.com/docs/admin/setup" data-href="https://firebase.google.com/docs/admin/setup" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Admin SDK</a> para inserir os dados na database. Então vou adicioná-lo também à nossa função:</p><pre name="5e4e" id="5e4e" class="graf graf--pre graf-after--p">const admin = require(&#39;firebase-admin&#39;);<br>admin.initializeApp(functions.config().firebase);</pre><p name="6e4f" id="6e4f" class="graf graf--p graf-after--pre">E a função ficaria assim:</p><figure name="46c1" id="46c1" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/c078c2ca2a8fc6a6a52e590019f86cdd.js"></script></figure><p name="51d8" id="51d8" class="graf graf--p graf-after--figure">Note que deixei o código anterior comentado, apenas para você poder comparar. E no fim, retorno uma mensagem de sucesso em formato JSON. É obrigatório que a nossa função retorne sempre dados nesse formato.</p><p name="81ae" id="81ae" class="graf graf--p graf-after--p">Repare também, que utilizando a Callable Function, já não precisamos da variável booleana <code class="markup--code markup--p-code">verificada</code> na nossa base de dados, pois não há risco da nossa Cloud Function cair num loop infinito. E assim poupamos espaço na database.</p><p name="fccd" id="fccd" class="graf graf--p graf-after--p">Quando terminar de escrever a função, não se esqueça de fazer o <code class="markup--code markup--p-code">firebase deploy</code>.</p><h4 name="27cf" id="27cf" class="graf graf--h4 graf-after--p">Chamando a função no Android</h4><p name="465a" id="465a" class="graf graf--p graf-after--h4">Agora que criamos a nossa função, vamos chamá-la na nossa aplicação.<br>Para começar, certifique-se que você tem a versão mais recente do Google Play Services (acima de 12.0.0) e adicione a dependência do Cloud Functions:</p><pre name="3ca7" id="3ca7" class="graf graf--pre graf-after--p">compile &#39;com.google.firebase:firebase-functions:12.0.0&#39;</pre><p name="e846" id="e846" class="graf graf--p graf-after--pre">E então chamamos a nossa função da seguinte forma:</p><figure name="36a0" id="36a0" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/90e5659d69e06f33912d29a2a7b7f0b2.js"></script></figure><h3 name="0b91" id="0b91" class="graf graf--h3 graf-after--figure">Lidando com erros</h3><p name="07c7" id="07c7" class="graf graf--p graf-after--h3">Imagine que ao chamar a função, você se esqueça de passar o parâmetro <code class="markup--code markup--p-code">texto</code> , ou passa com um outro nome por engano. Isto fará com que a função não salve nada na database, pois a variável <code class="markup--code markup--p-code">texto</code> estará null (undefined no Js). E você no Android ficará sem saber o que está acontecendo de errado.</p><p name="469b" id="469b" class="graf graf--p graf-after--p">Para evitar este problema, você pode verificar se o texto está vazio na Cloud Function e devolver um erro para o dispositivo Android. É só devolver um <a href="https://firebase.google.com/docs/reference/functions/functions.https#httpserror" data-href="https://firebase.google.com/docs/reference/functions/functions.https#httpserror" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">functions.https.HttpsError</a>:</p><pre name="770a" id="770a" class="graf graf--pre graf-after--p">if (!text || text.length === 0) {<br>  throw new functions.https.HttpsError(&#39;invalid-argument&#39;, &#39;A função deve conter o parametro &quot;texto&quot;.&#39;);<br>}</pre><p name="2834" id="2834" class="graf graf--p graf-after--pre">E no lado do cliente (Android), é só adicionar um <code class="markup--code markup--p-code">OnCompleteListener</code>:</p><figure name="f32c" id="f32c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/rosariopfernandes/555b60e5a65287219949dd0f85c98dad.js"></script></figure><p name="2daf" id="2daf" class="graf graf--p graf-after--figure graf--trailing">Creio que com isto, você já esteja preparado para criar outras Callable Cloud Functions para resolver vários outros problemas. Existem vários outros exemplos de casos em que estas funções podem ser úteis e provavelmente falarei de alguns desses casos nos meus próximos artigos.</p></div></div></section><section name="1977" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="a54e" id="a54e" class="graf graf--p graf--leading graf--trailing">Caso tenha alguma dúvida ou sugestão, pode me contactar pelo email <a href="mailto:rosariofernandes51@gmail.com" data-href="mailto:rosariofernandes51@gmail.com" class="markup--anchor markup--p-anchor" target="_blank">rosariofernandes51@gmail.com</a> ou pelo <a href="https://telegram.me/rosariopfernandes" data-href="https://telegram.me/rosariopfernandes" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener nofollow noopener nofollow noopener noopener nofollow noopener nofollow noopener noopener" target="_blank">Telegram</a>. Será um prazer conversar com você. 🙂</p></div></div></section>
