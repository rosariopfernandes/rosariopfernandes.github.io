---
layout: post
title:  "Firebase Cloud Functions — Pesquisa de Texto na Base de dados"
date:   2019-01-31 05:00:00 +0200
categories: firebase
---
O artigo original pode ser encontrado no [Medium](https://medium.com/android-dev-moz/fcf-search-7fd744b60dee).
<section name="43f2" class="section section--body section--first"><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="0023" id="0023" class="graf graf--h4 graf-after--h3 graf--subtitle">Algolia &amp; ElasticSearch vs Tocha</h4><p name="a669" id="a669" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">Este artigo é parte da série Firebase Cloud Functions:</strong></p><ol class="postList"><li name="aebc" id="aebc" class="graf graf--li graf-after--p"><a href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" data-href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" class="markup--anchor markup--li-anchor" target="_blank">O que é Firebase Cloud Functions?</a></li><li name="192b" id="192b" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Como começar?</a></li><li name="8f70" id="8f70" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" data-href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions + Cloud Messaging</a></li><li name="852d" id="852d" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Limpeza e Manutenção da Realtime Database</a></li><li name="d106" id="d106" class="graf graf--li graf-after--li"><a href="/firebase/2018/02/19/Functions-Callable.html" data-href="https://medium.com/@rosariopfernandes/48d503a6cd24" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions — Chame uma função na sua app</a></li><li name="d88e" id="d88e" class="graf graf--li graf-after--li graf--trailing">Firebase Cloud Functions — Pesquisa de Texto na Base de Dados</li></ol></div></div></section><section name="11ef" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="1d83" id="1d83" class="graf graf--p graf--leading">Uma das funcionalidades mais requisitadas à equipe do Firebase é a possibilidade de fazer a clássica “Pesquisa de Texto” na Realtime Database ou no Cloud Firestore. Para quem vem do SQL, esta é a famosa operação <code class="markup--code markup--p-code">LIKE</code>, que é bastante utilizada em caixas/campos de procura de texto.</p><p name="c0b8" id="c0b8" class="graf graf--p graf-after--p">Na altura em que a Realtime Database era o único serviço de Base de Dados do Firebase, esta funcionalidade já era pedida por desenvolvedores e, como solução, o Firebase trouxe a <a href="https://github.com/FirebaseExtended/flashlight" data-href="https://github.com/FirebaseExtended/flashlight" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Flashlight</strong></a> — uma biblioteca que conecta-se à plataforma ElasticSearch para permitir estas pesquisas.</p><p name="342b" id="342b" class="graf graf--p graf-after--p">Para quem não conhece, <a href="https://www.elastic.co/products/elasticsearch" data-href="https://www.elastic.co/products/elasticsearch" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ElasticSearch</a> é uma plataforma que faz a indexação de dados para futuras pesquisas. Ela funciona da seguinte forma: Você envia para a plataforma os dados que precisam ser indexados (neste caso, o nó da Realtime Database em que pretende pesquisar) e para fazer a pesquisa você envia uma requisição HTTP para a REST API deles e a API retorna os resultados da sua pesquisa.</p><p name="4312" id="4312" class="graf graf--p graf-after--p">Quando surgiu o Cloud Firestore, vimos várias funcionalidades de consulta(querying) de dados sendo adicionadas, que podemos dizer que são melhorias quando comparadas com as funcionalidades de consulta que existiam na Realtime Database. Mas infelizmente, ainda nada sobre a Pesquisa de Texto. Como solução, o Firebase criou um <a href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" data-href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Tutorial de como conectar Firestore à Algolia para Pesquisa de Texto</a>. <a href="https://www.algolia.com/" data-href="https://www.algolia.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Algolia</a> é outra plataforma de indexação muito similar ao ElasticSearch, inclusive funcionam da mesma maneira.</p><p name="2a5a" id="2a5a" class="graf graf--p graf-after--p">Apesar destas plataformas parecerem ser a solução perfeita, existem alguns aspetos a ter em conta:</p><ol class="postList"><li name="4d7c" id="4d7c" class="graf graf--li graf-after--p">Você está partilhando os seus dados com plataformas de terceiros;</li><li name="6b2c" id="6b2c" class="graf graf--li graf-after--li">É recomendado fazer as requisições em um servidor, pois estas plataformas dão-lhe uma Chave (API KEY) que não deverá ser exposta em aplicações cliente.</li></ol><p name="745d" id="745d" class="graf graf--p graf-after--li">Segundo o <a href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" data-href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tutorial do Firebase</a>, o 2º ponto que mencionei não será um problema, afinal de contas, existe o Firebase Cloud Functions que permite executar algumas funções no lado do servidor (server-side).</p><p name="017c" id="017c" class="graf graf--p graf-after--p">Apesar da combinação “Cloud Functions +Algolia/ElasticSearch” ser perfeita, ela tem um inconveniente: quando estiver a utilizar o plano grátis (Spark Plan) do Firebase, as Cloud Functions não podem enviar requisições para endereços externos (que não fazem parte da Google). Só quem estiver a utilizar um dos planos pagos (Flame ou Blaze Plan) é que tem a permissão para fazer isso.<br>Isto implica que caso você queira enviar requisições à Algolia/ElasticSearch através das Cloud Functions, você precisa adicionar o seu cartão de crédito e optar por um dos planos pagos.</p><p name="f80d" id="f80d" class="graf graf--p graf-after--p">Adicionar um cartão de crédito não deve ser problema para alguns, até porque mesmo depois de adicionar, eles não irão cobrar-lhe nada até que atinja um certo limite (conheça os limites na <a href="https://firebase.google.com/pricing/" data-href="https://firebase.google.com/pricing/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tabela de preços</a>) e este limite é alto o suficiente para que uma aplicação de pequena escala não o atinja em pouco tempo.</p><p name="31c8" id="31c8" class="graf graf--p graf-after--p">Mas por outro lado, existem desenvolvedores que não pretendem utilizar estes planos, mesmo porque provavelmente não utilizarão nem metade das funcionalidades oferecidas ou porque estão a desenvolver apenas um protótipo. Foi a pensar nestes desenvolvedores que decidi criar uma forma de fazer a Pesquisa de Texto no plano grátis (Spark).</p><h3 name="a5b5" id="a5b5" class="graf graf--h3 graf-after--p">Tocha — Pesquisas de Texto no Plano Spark</h3><p name="0a60" id="0a60" class="graf graf--p graf-after--h3"><a href="https://github.com/rosariopfernandes/Tocha" data-href="https://github.com/rosariopfernandes/Tocha" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Tocha</a> é uma biblioteca Open Source, por mim desenvolvida, que permite fazer pesquisas de texto no Cloud Firestore e na Realtime Database mesmo que o seu projeto ainda esteja no plano grátis (Spark). É ideal para protótipos ou pequenas aplicações Android/iOS. <br>E tal como as outras soluções de pesquisa de texto para o Firebase, esta biblioteca funciona através de Cloud Functions.</p><h4 name="01dc" id="01dc" class="graf graf--h4 graf-after--p">Como começar</h4><p name="aa0e" id="aa0e" class="graf graf--p graf-after--h4">Vou assumir que você já sabe criar e fazer o deploy de Cloud Functions. Caso não, leia o <a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--p-anchor" target="_blank">segundo artigo</a> desta série.</p><ol class="postList"><li name="2454" id="2454" class="graf graf--li graf-after--p">No directório functions do seu projeto Firebase, abra o ficheiro <em class="markup--em markup--li-em">package.json</em> e certifique-se que a sua cloud function está a utilizar o NodeJS na versão 8:</li></ol><pre name="0ea3" id="0ea3" class="graf graf--pre graf-after--li">{<br>  // ... name, description, dependencies, etc<br>  <strong class="markup--strong markup--pre-strong">&quot;engines&quot;</strong>: {<br>    <strong class="markup--strong markup--pre-strong">&quot;node&quot;</strong>: <strong class="markup--strong markup--pre-strong">&quot;8&quot;</strong><br>  }<br>}</pre><p name="12dd" id="12dd" class="graf graf--p graf-after--pre">2. Instale o Tocha, abrindo a terminal e utilizando o comando:</p><pre name="5fd9" id="5fd9" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">npm install tocha</strong></pre><p name="5eba" id="5eba" class="graf graf--p graf-after--pre">3. Por fim, abra o ficheiro <code class="markup--code markup--p-code">index.js</code> do directório <code class="markup--code markup--p-code">functions</code> e importe a(s) funcionalidade(s) do Tocha que você precisa:</p><pre name="2398" id="2398" class="graf graf--pre graf-after--p">const functions = require(&#39;firebase-functions&#39;);</pre><pre name="3bed" id="3bed" class="graf graf--pre graf-after--pre">// ... você pode importar mais bibliotecas aqui ...</pre><pre name="818a" id="818a" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">const tocha = require(&#39;tocha&#39;);</strong><br><br>// Para importar Pesquisa de texto no Cloud Firestore:<br><strong class="markup--strong markup--pre-strong">exports.searchFirestore = tocha.searchFirestore;</strong><br><br>// Para importar Pesquisa de texto na Realtime Database:<br><strong class="markup--strong markup--pre-strong">exports.searchRTDB = tocha.searchRTDB;</strong><br><br>// ... você pode declarar mais funções aqui ...</pre><p name="0c06" id="0c06" class="graf graf--p graf-after--pre">E pronto. Agora só basta fazer o deploy das novas funções:</p><pre name="1992" id="1992" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">firebase deploy --only functions</strong></pre><h4 name="bc19" id="bc19" class="graf graf--h4 graf-after--pre">Vamos Experimentar</h4><p name="a0d7" id="a0d7" class="graf graf--p graf-after--h4">Suponhamos que temos uma collection no Cloud Firestore que armazena tarefas para uma app de organização de tarefas. Vamos chamar esta collection de “tarefas”:</p><figure name="c0c7" id="c0c7" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 568px; max-height: 233px;"><div class="aspectRatioPlaceholder-fill"></div><img class="graf-image" data-image-id="1*OGS3nzYAVva2qT4JRuSxzg.png" data-width="568" data-height="233" src="https://cdn-images-1.medium.com/max/800/1*OGS3nzYAVva2qT4JRuSxzg.png"></div><figcaption class="imageCaption">A collection tarefas e um dos documentos que ela contem.</figcaption></figure><p name="af71" id="af71" class="graf graf--p graf-after--figure">Como vemos na imagem, a collection tem apenas 2 documentos, mas vamos supor que já tenhamos armazenado centenas de tarefas e já não nos lembramos à quem tínhamos de ligar para felicitar.<br>Vamos então utilizar o Tocha para pesquisar por tarefas que tenham a palavra “Ligar” no título. Para isso, temos de criar uma nova collection com o nome “tocha_searches”. Nesta collection vamos adicionar o seguinte documento:</p><pre name="be88" id="be88" class="graf graf--pre graf-after--p">{<br>  &quot;collectionName&quot;: &quot;tarefas&quot;, // collection que vamos pesquisar<br>  &quot;fields&quot;: [&quot;titulo&quot;], // campo(s) a pesquisar<br>  &quot;query&quot;: &quot;Ligar*&quot; // texto a ser encontrado<br>}</pre><p name="0dfe" id="0dfe" class="graf graf--p graf-after--pre">Ao adicionar este documento, a nossa Cloud Function será invocada e se estiver tudo correto, ela irá adicionar um campo <code class="markup--code markup--p-code">response</code> ao nosso documento contendo:</p><ul class="postList"><li name="fc25" id="fc25" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">isSuccessful</strong></code><strong class="markup--strong markup--li-strong"> </strong>(boolean) — este campo terá o valor <code class="markup--code markup--li-code">true</code> se a nossa pesquisa for bem sucedida ou <code class="markup--code markup--li-code">false</code> caso contrário.</li><li name="2ad9" id="2ad9" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">result</strong></code><strong class="markup--strong markup--li-strong"> </strong>— se a pesquisa for bem sucedida, este campo será um array contendo as tarefas que foram encontradas como resultado da pesquisa. <strong class="markup--strong markup--li-strong">Nota:</strong> Se ocorrer algum erro e <code class="markup--code markup--li-code">isSuccessful</code> for <code class="markup--code markup--li-code">false</code>, o campo result não existirá.</li><li name="b1bb" id="b1bb" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">errorMessage</strong></code> — só existe se tiver ocorrido algum erro e o valor do campo é uma String explicando a causa do erro.</li></ul><p name="64a1" id="64a1" class="graf graf--p graf-after--li">Então a nossa resposta ficará algo como:</p><figure name="8876" id="8876" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 462px; max-height: 305px;"><div class="aspectRatioPlaceholder-fill"></div><img class="graf-image" data-image-id="1*_DXBKv3evYr_57PchGgKgg.png" data-width="462" data-height="305" src="https://cdn-images-1.medium.com/max/800/1*_DXBKv3evYr_57PchGgKgg.png"></div></figure><p name="055a" id="055a" class="graf graf--p graf-after--figure">Num cenário real, só teríamos de ler o valor deste campo <code class="markup--code markup--p-code">result</code> e mostrá-lo na UI da nossa aplicação Android/iOS. E pronto, pesquisa implementada com sucesso.</p><h4 name="2443" id="2443" class="graf graf--h4 graf-after--p">Limitações</h4><p name="cd19" id="cd19" class="graf graf--p graf-after--h4">Tocha ainda é um projeto em desenvolvimento e possui algumas limitações:</p><ol class="postList"><li name="aff6" id="aff6" class="graf graf--li graf-after--p">Firestore/RTDB Security Rules não se aplicam na pesquisa. Isto significa que todas pesquisas realizadas assumem que o utilizador autenticado é administrador e tem acesso à toda base de dados.</li><li name="582b" id="582b" class="graf graf--li graf-after--li">Ainda não existe um SDK client-side para executar a pesquisa, mas já comecei a desenvolver um para android(<a href="https://github.com/rosariopfernandes/tocha-android" data-href="https://github.com/rosariopfernandes/tocha-android" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">tocha-android</a>).</li></ol><p name="4015" id="4015" class="graf graf--p graf-after--li">Vale lembrar que é um projeto Open Source, então você também é convidado à contribuir 🙂 O código-fonte e mais informações podem ser encontrados no GitHub:</p><a href="https://github.com/rosariopfernandes/Tocha" target="_blank">rosariopfernandes/Tocha</a><p name="cf39" id="cf39" class="graf graf--p graf-after--mixtapeEmbed graf--trailing">Espero que esta biblioteca ajude-o no desenvolvimento de protótipos e/ou pequenas aplicações móveis com pesquisa de texto no Firebase. 🙂</p></div></div></section><section name="2604" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="a6c2" id="a6c2" class="graf graf--p graf--leading graf--trailing">Caso tenha alguma dúvida ou sugestão, deixe abaixo nos comentários. Se você estiver tentando usar a Tocha e teve algum problema, <a href="https://github.com/rosariopfernandes/Tocha/issues/new" data-href="https://github.com/rosariopfernandes/Tocha/issues/new" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">abra um issue</a> no GitHub explicando o que você fez e qual foi o erro que teve.</p></div></div></section>
